package com.infinity.wefriends;

import java.util.List;

import com.infinity.utils.OnlineImageView;
import com.infinity.wefriends.apis.Messages;

import android.content.ContentValues;
import android.content.Context;
import android.os.Environment;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.BaseAdapter;
import android.widget.TextView;

public class ChatListAdapter extends BaseAdapter {
	
	protected List<ContentValues> chatList = null;
	protected Context m_context = null;
	protected LayoutInflater inflater = null;
	protected Messages messagesAPI = null;
	
	public ChatListAdapter(Context context, List<ContentValues> listValues) {
		chatList = listValues;
		m_context = context;
		inflater = LayoutInflater.from(context);
		messagesAPI = new Messages(context);
	}

	@Override
	public int getCount() {
		return chatList.size();
	}

	@Override
	public Object getItem(int arg0) {
		return null;
	}

	@Override
	public long getItemId(int pos) {
		return pos;
	}

	@Override
	public View getView(int pos, View arg1, ViewGroup arg2) {
		ContentValues chatInfo = chatList.get(pos);
		View itemView = inflater.inflate(R.layout.contact_list_item_view, null);
		TextView mainTitle = (TextView)itemView.findViewById(R.id.contact_list_item_view_main_title);
		TextView subtitle = (TextView)itemView.findViewById(R.id.contact_list_item_view_subtitle);
		OnlineImageView image = (OnlineImageView)itemView.findViewById(R.id.contact_list_item_view_avatar);
		TextView messageNotification = (TextView)itemView.findViewById(R.id.chat_item_notification);
		String chatType = chatInfo.getAsString("chattype");
		if (chatType.equals(Messages.MESSAGE_FRIEND_REQUEST)) {
			mainTitle.setText(m_context.getString(R.string.friend_request));
			subtitle.setText(chatInfo.getAsString("contactnickname"));
		} else if ((!chatInfo.getAsString("chatgroup").equals("")) && chatType.equals(Messages.MESSAGE_TEXT)) {
			mainTitle.setText(chatInfo.getAsString("chatgroup"));
			subtitle.setText(chatInfo.getAsString("contactnickname") + " : " + messagesAPI.getLastMessageFrom(chatInfo.getAsString("contact")));
		} else if ((!chatInfo.getAsString("chatgroup").equals("")) && (!chatType.equals(Messages.MESSAGE_TEXT))) {
			mainTitle.setText(chatInfo.getAsString("chatgroup"));
			subtitle.setText(chatInfo.getAsString("contactnickname"));
		} else if (chatType.equals(Messages.MESSAGE_TEXT)) {
			mainTitle.setText(chatInfo.getAsString("contact"));
			subtitle.setText(chatInfo.getAsString("message"));
		} else {
			mainTitle.setText(chatInfo.getAsString("contactnickname"));
		}
		int newMsgCnt = messagesAPI.getNonHandledMessageCountWith(chatInfo.getAsString("contact"));
		if (newMsgCnt>0)
			messageNotification.setVisibility(View.VISIBLE);
		if (newMsgCnt>99)
			messageNotification.setText("99");
		else
			messageNotification.setText(newMsgCnt + "");
		image.asyncLoadOnlineImage("http://" + m_context.getString(R.string.server_host) + ":" + m_context.getString(R.string.server_web_service_port) + "/" + chatInfo.getAsString("contactavatar"),Environment.getExternalStorageDirectory()+"/wefriends/cache");
		return itemView;
	}

}

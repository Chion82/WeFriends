package com.infinity.wefriends;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;

import com.infinity.utils.HttpRequest;
import com.infinity.utils.OnlineImageView;

import android.content.ContentValues;
import android.content.Context;
import android.os.Environment;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.BaseAdapter;
import android.widget.ImageView;
import android.widget.TextView;

public class ContactListAdapter extends BaseAdapter {
	
	protected List<ContentValues> contactList = null;
	protected List<String> groupList = null;
	protected List<HashMap<String,Integer>> parsedList = null;
	protected List<View> contactViewList = null;
	protected LayoutInflater inflater = null;
	protected Context m_context = null;
	
	public ContactListAdapter(Context context, List<ContentValues> valueList) {
		contactList = valueList;
		groupList = getGroupList();
		parsedList = parseContactList();
		inflater = LayoutInflater.from(context);
		m_context = context;
		contactViewList = new ArrayList<View>();
	}

	@Override
	public int getCount() {
		return parsedList.size();
	}

	@Override
	public Object getItem(int position) {
		Log.d("test","getItem()");
		return null;
	}

	@Override
	public long getItemId(int position) {
		return position;
	}

	@Override
	public View getView(int position, View convertView, ViewGroup parent) {
		Log.d("test","pos="+position);
		HashMap<String, Integer> itemMap = parsedList.get(position);
		if (itemMap.get("isGroup").equals(1)) {
			View groupView = inflater.inflate(R.layout.contact_list_group_toggle, null);
			((TextView)groupView.findViewById(R.id.contact_list_group_toggle_title)).setText(groupList.get(itemMap.get("groupIndex")));
			groupView.setOnClickListener(new friendGroupToggleListener(groupView, groupList.get(itemMap.get("groupIndex"))));
			return groupView;
		} else {
			View contactView = inflater.inflate(R.layout.contact_list_item_view, null);
			OnlineImageView.asyncLoadOnlineImage("http://" + m_context.getString(R.string.server_host) + ":" + m_context.getString(R.string.server_web_service_port) + "/" + contactList.get(itemMap.get("contactIndex")).getAsString("avatar"),Environment.getExternalStorageDirectory()+"/wefriends/cache",(OnlineImageView)contactView.findViewById(R.id.contact_list_item_view_avatar));
			((TextView)contactView.findViewById(R.id.contact_list_item_view_main_title)).setText(contactList.get(itemMap.get("contactIndex")).getAsString("nickname"));
			((TextView)contactView.findViewById(R.id.contact_list_item_view_subtitle)).setText(contactList.get(itemMap.get("contactIndex")).getAsString("whatsup"));
			contactView.setTag(contactList.get(itemMap.get("contactIndex")).getAsString("friendgroup"));
			contactViewList.add(contactView);
			return contactView;
		}
	}
	
	class friendGroupToggleListener implements View.OnClickListener {
		
		String m_friendGroup = null;
		boolean isCollapsed = false;
		View m_view = null;
		
		public friendGroupToggleListener(View view, String friendGroup) {
			m_friendGroup = friendGroup;
			m_view = view;
		}

		@Override
		public void onClick(View v) {
			int viewCount = contactViewList.size();
			for (int i=0;i<viewCount;i++) {
				if (((String)(contactViewList.get(i).getTag())).equals(m_friendGroup)){
					if (isCollapsed) {
						contactViewList.get(i).setVisibility(View.VISIBLE);
					} else {
						contactViewList.get(i).setVisibility(View.GONE);
					}
				}
			}
			if (isCollapsed) {
				((ImageView)m_view.findViewById(R.id.contact_list_group_toggle_icon)).setImageResource(R.drawable.ic_action_down);
				isCollapsed = false;
			} else {
				((ImageView)m_view.findViewById(R.id.contact_list_group_toggle_icon)).setImageResource(R.drawable.ic_action_play);
				isCollapsed = true;
			}
		}
	}
	
	protected List<String> getGroupList() {
		List<String> groupList = new ArrayList<String>();
		int contactCount = contactList.size();
		for (int i=0;i<contactCount;i++) {
			String groupName = contactList.get(i).getAsString("friendgroup");
			if (!groupList.contains(groupName)) {
				groupList.add(groupName);
			}
		}
		return groupList;
	}
	
	protected List<HashMap<String, Integer>> parseContactList() {
		int groupCount = groupList.size();
		int contactCount = contactList.size();
		List<HashMap<String, Integer>> resultList = new ArrayList<HashMap<String,Integer>>();
		for (int groupIndex=0;groupIndex<groupCount;groupIndex++) {
			HashMap<String,Integer> groupMap = new HashMap<String,Integer>();
			groupMap.put("isGroup", 1);
			groupMap.put("groupIndex", groupIndex);
			resultList.add(groupMap);
			String groupName = groupList.get(groupIndex);
			for (int contactIndex=0;contactIndex<contactCount;contactIndex++) {
				if (contactList.get(contactIndex).getAsString("friendgroup").equals(groupName)) {
					HashMap<String,Integer> contactMap = new HashMap<String,Integer>();
					contactMap.put("isGroup", 0);
					contactMap.put("contactIndex", contactIndex);
					resultList.add(contactMap);
					
				}
			}
		}
		return resultList;
	}

}

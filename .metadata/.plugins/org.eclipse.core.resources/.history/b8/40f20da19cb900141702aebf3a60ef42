package com.infinity.wefriends;

import com.infinity.wefriends.apis.Users;

import android.app.Activity;
import android.content.Context;
import android.content.Intent;
import android.widget.Button;
import android.widget.Toast;

public class AsyncConnTask {
	Users users = null;
	Context m_context = null;
	
	public AsyncConnTask(Context context) {
		m_context = context;
		users = new Users(context);
	}
	
	public void initCheckUserInfo() {
		Thread thread = new InitUserCheckThread();
		thread.start();
	}
	
	protected class InitUserCheckThread extends Thread {
		@Override
		public void run() {
			if (users.authenticateCachedAccessToken()==Users.TOKEN_INVALID) {
				Intent intent = new Intent();
				intent.setClass(AsyncConnTask.this.m_context,LoginActivity.class);
				AsyncConnTask.this.m_context.startActivity(intent);
				((MainActivity)AsyncConnTask.this.m_context).finish();
			} else {
				((MainActivity)AsyncConnTask.this.m_context).loadAllData();
			}
			super.run();
		}
	}
	
	public void login(String phone, String password) {
		LoginThread loginThread = new LoginThread(phone,password);
		loginThread.start();
	}
	
	protected class LoginThread extends Thread {
		protected String m_phone,m_password;
		public LoginThread(String phone, String password) {
			m_phone = phone;
			m_password = password;
		}
		@Override
		public void run() {
			int result = users.login(m_phone, m_password);
			switch(result) {
			case Users.LOGIN_OK:
				Intent intent = new Intent();
				intent.setClass(m_context, MainActivity.class);
				m_context.startActivity(intent);
				((Activity)m_context).finish();
				break;
			case Users.LOGIN_FAILED:
				Toast.makeText(m_context, R.string.login_failed, Toast.LENGTH_SHORT).show();
				((Button)((Activity)m_context).findViewById(R.id.loginwindow_login_button)).setEnabled(true);
				((Button)((Activity)m_context).findViewById(R.id.loginwindow_login_button)).setText(R.string.login);
				break;
			case Users.CONNECTION_ERROR:
				Toast.makeText(m_context, R.string.connection_error, Toast.LENGTH_SHORT).show();
				break;
			}
			super.run();
		}
		
	}

}
